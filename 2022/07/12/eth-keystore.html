
<!DOCTYPE html>
<html lang='en-US'>
<head>
  <meta charset='utf-8'>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Eth Keystore</title>
  <meta name="description" content="这是一个以太坊 keystore 文件的内容，我刚刚拿工具生成的：">
  <link rel="icon" href="/favicon.png" type="image/png">
  <link rel="icon" href="/favicon.svg" type="image/svg+xml">
  <link rel="canonical" href="https://eluvk.github.io/2022/07/12/eth-keystore.html">
  <link rel="alternate" type="application/rss+xml" title="EluvK" href="https://eluvk.github.io/feed.xml">
  <style>
  @font-face {
    font-family: 'Open Sans'; src: url('/css/OpenSans-300-Normal.woff2') format('woff2');
    font-weight: 300; font-style: normal;
  }
  @font-face {
    font-family: 'JetBrains Mono'; src: url('/css/JetBrainsMono-400-Normal.woff2') format('woff2');
    font-weight: 400; font-style: normal;
  }
  @font-face {
    font-family: 'JetBrains Mono'; src: url('/css/JetBrainsMono-700-Normal.woff2') format('woff2');
    font-weight: 700; font-style: normal;
  }
  @font-face {
    font-family: 'EB Garamond'; src: url('/css/EBGaramond-400-Normal.woff2') format('woff2');
    font-weight: 400; font-style: normal;
  }
  @font-face {
    font-family: 'EB Garamond'; src: url('/css/EBGaramond-400-Italic.woff2') format('woff2');
    font-weight: 400; font-style: italic;
  }
  @font-face {
    font-family: 'EB Garamond'; src: url('/css/EBGaramond-700-Normal.woff2') format('woff2');
    font-weight: 700; font-style: normal;
  }
  @font-face {
    font-family: 'EB Garamond'; src: url('/css/EBGaramond-700-Italic.woff2') format('woff2');
    font-weight: 700; font-style: italic;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; margin-block-start: 0; margin-block-end: 0; }

  body {
    max-width: 100ch;
    padding: 4ch;
    margin-left: auto;
    margin-right: auto;
  }

  header { margin-bottom: 2rem; }
  header > nav { display: flex; column-gap: 2ch; align-items: baseline; flex-wrap: wrap; }
  header a { font-style: normal; color: rgba(0, 0, 0, .8); text-decoration: none; }
  header a:hover { color: rgba(0, 0, 0, .8); text-decoration: underline; }
  header .title { font-size: 1.25em; flex-grow: 2; }

  footer { margin-top: 2rem; }
  footer > p { display: flex; column-gap: 2ch; justify-content: center; flex-wrap: wrap; }
  footer a { color: rgba(0, 0, 0, .8); text-decoration: none; white-space: nowrap; }
  footer i { vertical-align: middle; color: rgba(0, 0, 0, .8) }

  </style>

  <link rel="stylesheet" href="/css/main.css">
  
  <script type="text/javascript" id="MathJax-script" async="" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
</head>

<body>
  <header>
    <nav>
      <a class="title" href="/">EluvK</a>
      <a href="/shortcuts.html">ShortCuts</a>
      <a href="/about.html">About</a>
      <!-- 
      <a href="/resume.html">Resume</a>
      <a href="/links.html">Links</a> 
      -->
    </nav>
  </header>

  <main>
  <article >

    <h1>
    <a href="#Eth-Keystore"><span>Eth Keystore</span> <time datetime="2022-07-12">Jul 12, 2022</time></a>
    </h1>
<section id="Overview">

    <h2>
    <a href="#Overview"><span>Overview</span> </a>
    </h2>
<p><span>这是一个以太坊 keystore 文件的内容，我刚刚拿工具生成的：</span></p>

<figure class="code-block">


<pre><code><span class="line"><span class="hl-punctuation">{</span></span>
<span class="line">    <span class="hl-attr">&quot;address&quot;</span><span class="hl-punctuation">:</span> <span class="hl-string">&quot;0x7579e895f588d668c181710d74cc4c0ed4c8871b&quot;</span><span class="hl-punctuation">,</span></span>
<span class="line">    <span class="hl-attr">&quot;crypto&quot;</span><span class="hl-punctuation">:</span> <span class="hl-punctuation">{</span></span>
<span class="line">        <span class="hl-attr">&quot;cipher&quot;</span><span class="hl-punctuation">:</span> <span class="hl-string">&quot;aes-128-ctr&quot;</span><span class="hl-punctuation">,</span></span>
<span class="line">        <span class="hl-attr">&quot;ciphertext&quot;</span><span class="hl-punctuation">:</span> <span class="hl-string">&quot;d7e10d319e6a03bd6d4461da69c818418fc25f138bf98b854baf6fdd6feeeea5&quot;</span><span class="hl-punctuation">,</span></span>
<span class="line">        <span class="hl-attr">&quot;cipherparams&quot;</span><span class="hl-punctuation">:</span> <span class="hl-punctuation">{</span></span>
<span class="line">            <span class="hl-attr">&quot;iv&quot;</span><span class="hl-punctuation">:</span> <span class="hl-string">&quot;deb0e25a32ad2c8f28fa3d83c90c6a37&quot;</span></span>
<span class="line">        <span class="hl-punctuation">}</span><span class="hl-punctuation">,</span></span>
<span class="line">        <span class="hl-attr">&quot;kdf&quot;</span><span class="hl-punctuation">:</span> <span class="hl-string">&quot;scrypt&quot;</span><span class="hl-punctuation">,</span></span>
<span class="line">        <span class="hl-attr">&quot;kdfparams&quot;</span><span class="hl-punctuation">:</span> <span class="hl-punctuation">{</span></span>
<span class="line">            <span class="hl-attr">&quot;dklen&quot;</span><span class="hl-punctuation">:</span> <span class="hl-number">32</span><span class="hl-punctuation">,</span></span>
<span class="line">            <span class="hl-attr">&quot;n&quot;</span><span class="hl-punctuation">:</span> <span class="hl-number">262144</span><span class="hl-punctuation">,</span></span>
<span class="line">            <span class="hl-attr">&quot;p&quot;</span><span class="hl-punctuation">:</span> <span class="hl-number">1</span><span class="hl-punctuation">,</span></span>
<span class="line">            <span class="hl-attr">&quot;r&quot;</span><span class="hl-punctuation">:</span> <span class="hl-number">8</span><span class="hl-punctuation">,</span></span>
<span class="line">            <span class="hl-attr">&quot;salt&quot;</span><span class="hl-punctuation">:</span> <span class="hl-string">&quot;4595597c7002cfc47db91cbd1bf6faa9d9d4b45a205563537eb4e8bc33b0720b&quot;</span></span>
<span class="line">        <span class="hl-punctuation">}</span><span class="hl-punctuation">,</span></span>
<span class="line">        <span class="hl-attr">&quot;mac&quot;</span><span class="hl-punctuation">:</span> <span class="hl-string">&quot;2968ba58ac928feb6f95564e0083f186c4a605edfdffbbe35a7d47e0f32ed03c&quot;</span></span>
<span class="line">    <span class="hl-punctuation">}</span><span class="hl-punctuation">,</span></span>
<span class="line">    <span class="hl-attr">&quot;id&quot;</span><span class="hl-punctuation">:</span> <span class="hl-string">&quot;48258957-776e-40b7-9ebd-068dd8f1156a&quot;</span><span class="hl-punctuation">,</span></span>
<span class="line">    <span class="hl-attr">&quot;version&quot;</span><span class="hl-punctuation">:</span> <span class="hl-number">3</span></span>
<span class="line"><span class="hl-punctuation">}</span></span></code></pre>

</figure>
<p><span>在了解每个字段含义之前，后面不会再解释的基础名词如下：</span></p>
<ul>
<li>
<span>私钥(private key): 长度为 </span><code>256 bit = 32 bytes</code><span> 的随机的密钥，一切加密的源头</span>
</li>
<li>
<span>公钥(public key): 和私钥对应的公钥， 长度为 </span><code>512 bit = 64 bytes</code><span> ， 由 私钥 + 椭圆曲线加密 计算出来。可以由私钥推出公钥，无法从公钥推出私钥。具体的椭圆曲线算法参数 </span><a href="https://en.bitcoin.it/wiki/Secp256k1"><code>secp256k1</code></a><span> 和比特币一样。</span>
</li>
<li>
<span>账户地址(address): 由公钥进行 </span><code>keccak256</code><span> hash 运算后取后20个字节，以太坊给账号作标记的地址。</span>
</li>
<li>
<span>密码(password): 用于加密 </span><code>keystore</code><span> 文件的密码，可以是任意长度的字符串。保护 keystore 文件不那么容易被破解。</span>
</li>
</ul>
<hr>
<p><span>再来解释上面 JSON 文件里每个字段的含义：</span></p>

<figure class="code-block">


<pre><code><span class="line"><span class="hl-punctuation">{</span></span>
<span class="line">    <span class="hl-attr">&quot;address&quot;</span><span class="hl-punctuation">:</span> <span class="hl-string">&quot;地址&quot;</span><span class="hl-punctuation">,</span></span>
<span class="line">    <span class="hl-attr">&quot;crypto&quot;</span><span class="hl-punctuation">:</span> <span class="hl-punctuation">{</span></span>
<span class="line">        <span class="hl-attr">&quot;cipher&quot;</span><span class="hl-punctuation">:</span> <span class="hl-string">&quot;使用的(对称加密的)加密方法名，默认使用对称 [AES 加密] 中的某一种&quot;</span><span class="hl-punctuation">,</span></span>
<span class="line">        <span class="hl-attr">&quot;ciphertext&quot;</span><span class="hl-punctuation">:</span> <span class="hl-string">&quot;私钥 + 密码 被该 cipher 加密方式加密后的结果&quot;</span><span class="hl-punctuation">,</span></span>
<span class="line">        <span class="hl-attr">&quot;cipherparams&quot;</span><span class="hl-punctuation">:</span> <span class="hl-punctuation">{</span></span>
<span class="line">            <span class="hl-attr">&quot;iv&quot;</span><span class="hl-punctuation">:</span> <span class="hl-string">&quot;该 cipher 加密方式需要的参数 (随机初始向量) `initialisation vector` &quot;</span></span>
<span class="line">        <span class="hl-punctuation">}</span><span class="hl-punctuation">,</span></span>
<span class="line">        <span class="hl-attr">&quot;kdf&quot;</span><span class="hl-punctuation">:</span> <span class="hl-string">&quot;使用的(基于密码的)加密方法名，`Key-derivation function` 一般用 [Scrypt] 也支持 [PBKDF2]&quot;</span><span class="hl-punctuation">,</span></span>
<span class="line">        <span class="hl-attr">&quot;kdfparams&quot;</span><span class="hl-punctuation">:</span> <span class="hl-punctuation">{</span> <span class="hl-comment">// 该 kdf 加密方式需要的参数，除了盐值是随机生成的，其他参数推荐使用默认。</span></span>
<span class="line">            <span class="hl-attr">&quot;dklen&quot;</span><span class="hl-punctuation">:</span> <span class="hl-number">32</span><span class="hl-punctuation">,</span> <span class="hl-comment">// 生成的 key 的 bytes 长度</span></span>
<span class="line">            <span class="hl-attr">&quot;n&quot;</span><span class="hl-punctuation">:</span> <span class="hl-number">262144</span><span class="hl-punctuation">,</span> <span class="hl-comment">// 迭代次数，线性影响计算难度和内存占用</span></span>
<span class="line">            <span class="hl-attr">&quot;p&quot;</span><span class="hl-punctuation">:</span> <span class="hl-number">1</span><span class="hl-punctuation">,</span> <span class="hl-comment">// 并行计算数</span></span>
<span class="line">            <span class="hl-attr">&quot;r&quot;</span><span class="hl-punctuation">:</span> <span class="hl-number">8</span><span class="hl-punctuation">,</span> <span class="hl-comment">// 块大小，和 n 一起线性影响计算难度和内存占用</span></span>
<span class="line">            <span class="hl-attr">&quot;salt&quot;</span><span class="hl-punctuation">:</span> <span class="hl-string">&quot;盐值，随机生成的混淆参数&quot;</span></span>
<span class="line">        <span class="hl-punctuation">}</span><span class="hl-punctuation">,</span></span>
<span class="line">        <span class="hl-attr">&quot;mac&quot;</span><span class="hl-punctuation">:</span> <span class="hl-string">&quot;message authentication code 消息验证码，用于校验 password 是否正确&quot;</span></span>
<span class="line">    <span class="hl-punctuation">}</span><span class="hl-punctuation">,</span></span>
<span class="line">    <span class="hl-attr">&quot;id&quot;</span><span class="hl-punctuation">:</span> <span class="hl-string">&quot;随机生成的 UUID，和 keystore 加密本身关系不大&quot;</span><span class="hl-punctuation">,</span></span>
<span class="line">    <span class="hl-attr">&quot;version&quot;</span><span class="hl-punctuation">:</span> <span class="hl-number">3</span> <span class="hl-comment">// 版本号</span></span>
<span class="line"><span class="hl-punctuation">}</span></span></code></pre>

</figure>
<p><span>整个 keystore 的加密，通过两类加密模式(cipher + kdf)来加密密码和私钥。从而达到的效果是：只有知道密码的用户才能利用 keystore 文件解出私钥，而想要暴力破解 keystore 也比较困难。</span></p>
<p><span>其中涉及到的加密算法 WIKI 链接：也许未来会进一步学习下啊巴啊巴</span>&hellip;</p>
<ul>
<li>
<a href="https://en.wikipedia.org/wiki/Advanced_Encryption_Standard"><span>AES 加密(Advanced</span><em><span>Encryption</span></em><span>Standard)</span></a>
</li>
<li>
<a href="https://en.wikipedia.org/wiki/Scrypt"><span>Scrypt</span></a>
</li>
<li>
<a href="https://en.wikipedia.org/wiki/PBKDF2"><span>PBKDF2</span></a>
</li>
<li>
<a href="https://en.wikipedia.org/wiki/SHA-3"><span>keccak256</span></a>
</li>
</ul>
<section id="Generate-Keystore">

    <h3>
    <a href="#Generate-Keystore"><span>Generate Keystore</span> </a>
    </h3>
<p><span>来看看生成 keystore 的流程，目标是一个 keystore 文件和我们心中的密码，比如</span><code>"some_password"</code><span>，它蕴含了一个32字节的私钥。私钥是生成 keystore 的数据源头，所以是整个算法过程中的参数。</span></p>
<p><span>除此之外，加上上面 JSON 文件里的众多参数里，可以分为三类：</span></p>
<p><span>随机的输入参数，由随机器/用户定义生成的内容</span></p>
<ul>
<li>
<span>用户定义，不在文件里的私钥</span>
</li>
<li>
<span>用户定义，不在文件里的密码</span>
</li>
<li>
<span>随机生成： </span><code>cipherparams.iv</code><span> cipher 初始向量</span>
</li>
<li>
<span>随机生成： </span><code>kdfparams.salt</code><span> kdf 盐值</span>
</li>
</ul>
<p><span>算法需要的参数或固定参数，控制了加密的强度或者其他标记</span></p>
<ul>
<li>
<span>kdfparams.dklen/n/p/r</span>
</li>
<li>
<span>version</span>
</li>
<li>
<span>id</span>
</li>
</ul>
<p><span>算法的计算结果，由上面两类数据生成，写入文件为了校验/使用</span></p>
<ul>
<li>
<span>address： 对应了公钥</span>
</li>
<li>
<span>ciphertext: 私钥加密结果</span>
</li>
<li>
<span>mac： 验证码，用于在解密时验证密码是否正确</span>
</li>
</ul>
<p><span>除掉相对固定的参数，整个方法可以认为是 </span><span class="math inline">\(F(prikey, password, iv, salt) \rightarrow mac, ciphertext\)</span></p>
<p><span>另外有 </span><span class="math inline">\(G(prikey) \rightarrow pubkey, address\)</span><span> ，单独就可以生成。</span></p>
<section id="Generate">

    <h4>
    <a href="#Generate"><span>Generate 算法步骤</span> </a>
    </h4>
<p><span>私钥推出公钥和地址</span></p>
<p><span class="math display">\[G(prikey) \rightarrow pubkey, address\]</span></p>
<p><code>password + salt</code><span> 经过 </span><code>kdf 算法(Scrypt)</code><span> 得到中间计算结果 </span><code>key (256bits 32bytes)</code></p>
<p><span class="math display">\[Scrypt(password, salt, kdfparams) \rightarrow key\]</span></p>
<p><code>prikey</code><span> 作为初始数据，经过对称加密 </span><code>cipher 算法(AES128)</code><span> ，应用数据：</span><code>key</code><span> 的前16字节，</span><code>iv</code><span> 的前16字节，得到加密后的 </span><code>ciphertext</code></p>
<p><span class="math display">\[AES128(prikey, key[0..16], iv[0..16]) \rightarrow ciphertext\]</span></p>
<p><code>key[16..32] + ciphertext</code><span> 合起来，经过 </span><code>keccak256算法</code><span> 作 hash256，得到结果 </span><code>mac</code></p>
<p><span class="math display">\[keccak256(key[16..32] + ciphertext) \rightarrow mac\]</span></p>
<p><span>经过这四步，即把私钥和密码加密出来，计算出了校验用的 </span><code>ciphertext</code><span> 和 </span><code>mac</code></p>
</section>
</section>
<section id="Decrypt-Keystore">

    <h3>
    <a href="#Decrypt-Keystore"><span>Decrypt Keystore</span> </a>
    </h3>
<p><span>解码 Keystore 需要 keystore 文件和密码，密码正确的结果是解出来的密钥，密码错误会出错。</span></p>
<section id="Decrypt">

    <h4>
    <a href="#Decrypt"><span>Decrypt 算法步骤</span> </a>
    </h4>
<p><span>根据输入的 </span><code>password'</code><span> 计算 </span><code>key'</code><span> ，此步骤算法同上面的 #2，因为输入和中间结果 </span><code>key</code><span> 不一定正确，后面加了一个 </span><code>'</code><span> 做区分</span></p>
<p><span class="math display">\[Scrypt(password', salt, kdfparams) \rightarrow key'\]</span></p>
<p><code>key'[16..32] + ciphertext</code><span> 合起来，经过 </span><code>keccak256算法</code><span> 作 hash256，得到结果 </span><code>mac'</code><span>, 和上面的步骤4一样，计算出 </span><code>mac'</code><span> 校验密码是否正确。</span></p>
<p><span class="math display">\[keccak256(key'[16..32] + ciphertext) \rightarrow mac'\]</span></p>
<p><span>验证 </span><code>mac'</code><span> 是否等于 </span><code>mac</code></p>
<p><span class="math display">\[(mac'==mac)?continue:exit\]</span></p>
<p><code>ciphertext</code><span> 作为初始数据，经过对称加密 </span><code>cipher 算法(AES128)</code><span> ，应用数据：</span><code>key'</code><span> 的前16字节，</span><code>iv</code><span> 的前16字节，恢复出私钥</span></p>
<p><span class="math display">\[AES128(ciphertext, key'[0..16], iv[0..16]) \rightarrow prikey\]</span></p>
</section>
</section>
<section id="s-1">

    <h3>
    <a href="#s-1"><span>实现</span> </a>
    </h3>
<p><span>加密和解密的方法，拿 </span><code>Rust</code><span> 实现了一下： </span><a href="https://github.com/CharlesLiu-TOPNetwork/keystore-rs"><span>仓库链接</span></a></p>
</section>
<section id="s-2">

    <h3>
    <a href="#s-2"><span>总结</span> </a>
    </h3>
<p><span>完整的思维导图</span></p>

<figure>

<img alt="2022-07/keystore.png" src="https://github.com/EluvK/eluvk.github.io/raw/master/content/assets/2022-07/keystore.png">
</figure>
<p><span>推荐拓展阅读:</span></p>
<ul>
<li>
<span>https://julien-maffre.medium.com/what-is-an-ethereum-keystore-file-86c8c5917b97</span>
</li>
<li>
<span>https://betterprogramming.pub/understanding-ethereum-cryptography-3ef7429eddce</span>
</li>
<li>
<span>https://cryptobook.nakov.com/symmetric-key-ciphers/</span>
</li>
</ul>
</section>
</section>
</article>
  </main>

  <footer class="site-footer">
    <p>
      <a href="https://github.com/EluvK/eluvk.github.io/edit/master/content/posts/2022-07-12-eth-keystore.dj">
        <svg class="icon"><use href="/assets/icons.svg#edit"/></svg>
        Fix typo
      </a>
      <a href="/feed.xml">
        <svg class="icon"><use href="/assets/icons.svg#rss"/></svg>
        Subscribe
      </a>
      <a href="mailto:eluvk.dev+blog@gmail.com">
        <svg class="icon"><use href="/assets/icons.svg#email"/></svg>
        Get in touch
      </a>
      <a href="https://github.com/EluvK">
        <svg class="icon"><use href="/assets/icons.svg#github"/></svg>
        EluvK
      </a>
    </p>
  </footer>
</body>

</html>
